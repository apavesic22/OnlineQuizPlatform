<div class="manage-container">
  <div class="header-row">
    <h1>User Management</h1>
    @if (isAdmin) {
      <button mat-raised-button color="accent" (click)="openCreateDialog()">
        <mat-icon>person_add</mat-icon> Add New User
      </button>
    }
  </div>

  <mat-form-field appearance="outline" class="search-field">
    <mat-label>Search by username or email</mat-label>
    <mat-icon matPrefix>search</mat-icon>
    <input matInput (input)="onSearch($event)" placeholder="Search users...">
  </mat-form-field>

  @if (loading) {
    <div class="loading-spinner">Loading users...</div>
  } @else {
    <div class="responsive-table-wrapper">
      <table mat-table [dataSource]="users" class="mat-elevation-z8">
        
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef> Username </th>
          <td mat-cell *matCellDef="let u"> 
            {{u.username}} 
            @if (u.verified) {
              <mat-icon color="primary" class="verified-badge">verified</mat-icon>
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef> Email </th>
          <td mat-cell *matCellDef="let u"> {{u.email}} </td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef> Role </th>
          <td mat-cell *matCellDef="let u"> {{u.role_name}} </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let u">
            <span [class.status-verified]="u.verified">
              {{ u.verified ? 'Verified' : 'Standard' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let u">
            <div class="action-group">
              @if (isManager) {
                <button mat-stroked-button 
                        [color]="u.verified ? 'warn' : 'primary'" 
                        (click)="toggleVerification(u)">
                  {{ u.verified ? 'Unverify' : 'Verify' }}
                </button>
              }

              @if (isAdmin) {
                <button mat-icon-button color="primary" (click)="openEditDialog(u)" title="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteUser(u)" title="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              }
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <mat-paginator 
      [length]="totalUsers"
      [pageSize]="pageSize"
      [pageIndex]="currentPage"
      [pageSizeOptions]="[5, 10, 25, 100]"
      (page)="onPageChange($event)">
    </mat-paginator>
  }
</div>